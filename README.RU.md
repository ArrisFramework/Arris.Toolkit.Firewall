# Arris.Toolkit.Firewall



Библиотека, предоставляющая функции фильтрации IP-адресов

| Type        | Syntax                      | Details                                                                                                                       |
|-------------|-----------------------------|-------------------------------------------------------------------------------------------------------------------------------|
| IPV4        | `192.168.0.1`               |                                                                                                                               |
| Range       | `192.168.0.0-192.168.1.60`  | Includes all IPs from `192.168.0.0` to `192.168.0.255`<br />and from `192.168.1.0` to `198.168.1.60`                          |
| Wild card   | `192.168.0.*`               | IPs starting with `192.168.0`<br />Same as IP Range `192.168.0.0-192.168.0.255`                                               |
| Subnet mask | `192.168.0.0/255.255.255.0` | (НЕ ПОДДЕРЖИВАЕТСЯ) IPs starting with `192.168.0`<br />Same as `192.168.0.0-192.168.0.255` and `192.168.0.*`                  |
| CIDR Mask   | `192.168.0.0/24`            | IPs starting with `192.168.0`<br />Same as `192.168.0.0-192.168.0.255` and `192.168.0.*`<br />and `192.168.0.0/255.255.255.0` |

## Basic usage

```php
use Arris\Toolkit\FireWall;

$whiteList = [
    '127.0.0.1',
    '192.168.0.*',
];

$blackList = [
    '192.168.0.50',
];

$firewall = new FireWall(
    defaultState: false,
    deferred_range_sorting: true 
);

$connAllowed = $firewall
    ->setDefaultState(false)
    ->addWhiteList($whiteList)
    ->addBlackList($blackList)
    ->validate('195.88.195.146')
    ->isAllowed()
;

if (!$connAllowed) {
    http_response_code(403); // Forbidden
    exit();
}
```
#### Конструктор:

```php
$firewall = new FireWall(
    defaultState: false,
    deferred_range_sorting: true 
);
```

- `defaultState` - правило для диапазона `*.*.*.*`. По умолчанию false, то есть запрещено. Допустимы значения:
    - `null` (эквивалентно false)
    - `true|false`
    - `\Arris\Toolkit\FireWall\FireWallState::FORBIDDEN` или `Arris\Toolkit\FireWall\FireWallState::ALLOWED`
- `deferred_range_sorting` - использовать ли отложенную сортировку диапазонов?
    - `true`: на этапе validate (сортирует диапазоны каждый раз вызове validate(), имеет смысл, если тестируем айпишник 1 раз)
    - `false`: на этапе добавления (имеет смысл, если мы тестируем несколько айпишников по одному набору правил)

#### Добавление диапазонов

- `addWhiteList()` - добавляем диапазон(ы) в белый список
- `addBlackList()` - добавляем диапазон(ы) в черный список

Аргументы - строка или массив строк вида:

- `192.168.0.1` - одиночный IP
- `192.168.0.0-192.168.1.60` - диапазон
- `192.168.0.*` - диапазон по wildcard (допустим диапазон `*`)
- `192.168.0.0/24` - CIDR

Диапазон `192.168.0.0/255.255.255.0` пока не поддерживается!

- `addRange(range, type)` - диапазон и тип списка - поле enum FireWallState

## Пример сложный (и искусственный)

```php
$firewall = new FireWall();
$i = $firewall
    ->addBlackList('192.168.0.0/16')            // 192.168.0.0 - 192.168.255.255
    ->addWhiteList('192.168.0.0/24')            // + 0-255
    ->addBlackList('192.168.0.10-192.168.0.80') // - 10-80
    ->addBlackList('192.168.0.100-192.168.0.121') // - 100-121
    ->addWhiteList('192.168.0.42')  // + 42
    ->addWhiteList('192.168.0.120') // + 120
    ->addBlackList('192.168.0.5')   // - 5

$equals = [
    '192.168.0.0'   =>  true,
    '192.168.0.1'   =>  true,
    '192.168.0.10'  =>  false,
    '192.168.0.42'  =>  true,
    '192.168.0.99'  =>  true,
    '192.168.0.100' =>  false,
    '192.168.0.5'   =>  false,
    '192.168.0.200' =>  true,
    '192.168.0.70'  =>  false
];
```

## Нюансы

- при перекрытии диапазонов "сильнее" тот, который имеет меньшую мощность
- при перекрытии диапазонов равной мощности результат не определен (скорее всего будет использован тот, который объявлен раньше)

## Как это работает?

- Задаем диапазоны айпишников (белые и черные)
- Принадлежность полного диапазона (`*.*.*.*`) к black/white листу зависит от настроек
- Вычисляются мощности диапазонов
- Диапазоны сортируются по мощности
- Ищется кратчайший диапазон, в который входит тестируемый айпишник
- Тип этого диапазона и есть состояние для айпишника - ALLOWED или FORBIDDEN

## License

Firewall is licensed under the [MIT license](LICENSE).

